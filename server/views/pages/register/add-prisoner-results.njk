{% extends "layout.njk" %}

{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}

{% set pageTitle = applicationName + " - Add prisoner results" %}
{% set mainClasses = "govuk-body" %}
{% set backLinkHref = "./add-prisoner" %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <span class="govuk-caption-l">{{ payType.description }}</span>
            <h1 class="govuk-heading-l">Who do you want to add?</h1>

            <form method="POST" action="/{{ payType.slug }}/register/add-prisoner">
                <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-two-thirds">
                        <div class="search-input {{ params.classes }}">
                            <div class="search-input__form-inputs {{ params.formInputs.classes }}">
                                {{ govukInput({
                                    id: "query",
                                    name: "query",
                                    hint: {
                                        text: 'Search by name or prison number.'
                                    },
                                    type: "search",
                                    value: query,
                                    errorMessage: errors | findError("query"),
                                    attributes: {
                                        'data-qa': 'query'
                                    }
                                }) }}
                                {% if prisoners | length === 0 %}
                                    {{ govukButton({
                                        text: "Search",
                                        type: "submit"
                                    }) }}
                                {% else %}
                                    {{ govukButton({
                                        text: "Search",
                                        type: "submit",
                                        classes: "govuk-button--secondary"
                                    }) }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            {% if prisoners | length >= 1 %}
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-full">
                        <form method="POST">
                            <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
                            {% set prisonerRows = [] %}
                            {% for prisoner in prisoners %}
                                {% if prisoners | length > 1 %}
                                    {% set prisonerName = '<div class="govuk-radios govuk-radios--small" data-module="govuk-radios">' +
                                        '<div class="govuk-radios__item">' +
                                            '<input type="radio" id="selected-prisoner-' + prisoner.prisonerNumber + '" name="selectedPrisoner" value="' + prisoner.prisonerNumber + '" class="govuk-radios__input"/>' +
                                            '<label for="selected-prisoner-' + prisoner.prisonerNumber + '" class="govuk-label govuk-radios__label">' + prisoner | formatName(NameFormatStyle.lastCommaFirst, false) + '<label>' +
                                        '</div>' +
                                    '</div>'
                                %}
                                {% else %}
                                    {% set prisonerName = '<input type="hidden" name="selectedPrisoner" value="' + prisoner.prisonerNumber + '"> ' + prisoner | formatName(NameFormatStyle.lastCommaFirst, false) %}
                                {% endif %}

                                {% set prisonerRows = (prisonerRows.push([
                                    {
                                        attributes: {
                                            id: 'prisoner-name',
                                            "data-sort-value": prisoner | formatName(NameFormatStyle.lastCommaFirstMiddle, false)
                                        },
                                        html: prisonerName
                                    }, {
                                        attributes: {
                                            id: 'prisoner-number',
                                            "data-sort-value": prisoner.prisonerNumber
                                        },
                                        text: prisoner.prisonerNumber
                                    }, {
                                        attributes: {
                                            id: 'prisoner-cell-location',
                                            "data-sort-value": prisoner.cellLocation
                                        },
                                        text: prisoner.cellLocation
                                    }
                                ]), prisonerRows) %}
                            {% endfor %}

                            {% if prisoners | length > 10 %}
                                {{ govukButton({
                                    text: "Select and continue",
                                    id: "continue-button-above-results"
                                }) }}
                            {% endif %}

                            {% set groupClasses = "govuk-form-group govuk-form-group--error" if errors | findError("selectedPrisoner") else "govuk-form-group" %}
                            <div class="{{ groupClasses }}">
                                {% if errors | findError("selectedPrisoner") %}
                                    <p id="query-error" class="govuk-error-message">
                                        <span class="govuk-visually-hidden">Error:</span> {{ (errors | findError("selectedPrisoner")).text }}
                                    </p>
                                {% endif %}
                                {{ govukTable({
                                    attributes: {
                                        'data-module': 'moj-sortable-table',
                                        'data-qa': 'prisoner-search-results-table'
                                    },
                                    caption: "Prisoner search list",
                                    classes: "fixed-layout-table",
                                    captionClasses: "govuk-visually-hidden",
                                    errorMessage: errors | findError("selectedPrisoner"),
                                    head: [{
                                        text: "Name",
                                        attributes: {
                                            "aria-sort": "ascending"
                                        }
                                    }, {
                                        text: "Prison number",
                                        attributes: {
                                            "aria-sort": "none"
                                        }
                                    }, {
                                        text: "Cell location",
                                        attributes: {
                                            "aria-sort": "none"
                                        }
                                    }],
                                    rows: prisonerRows
                                }) }}
                            </div>
                            <div class="govuk-button-group">
                                {{ govukButton({
                                    text: "Select and continue" if prisoners | length > 1 else "Continue",
                                    id: "continue-button"
                                }) }}
                                <a class="govuk-link--no-visited-state" href="../pay-overview">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}